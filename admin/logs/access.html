<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクセスログ - お問い合わせ管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { format, parseISO } from 'https://cdn.skypack.dev/date-fns';
        
        // グローバルに使えるように設定
        window.dateFns = { format, parseISO };
    </script>
    
    <link rel="stylesheet" href="/admin/assets/css/mobile-optimize.css">
</head>
<body class="bg-gray-50">

    <!-- モバイル用メニューボタン -->
    <button class="menu-toggle md:hidden" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>
    <div class="overlay" id="overlay"></div>
    <!-- サイドバー -->
    <div class="flex">
        <aside class="w-64 bg-slate-800 text-white min-h-screen fixed left-0 top-0 z-10">
            <!-- ヘッダー -->
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold">管理画面</h1>
                <p class="text-sm text-slate-400">お問い合わせ管理システム</p>
            </div>
            
            <!-- ナビゲーション -->
            <nav class="mt-6">
                <a href="../index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    ダッシュボード
                </a>
                <a href="../contacts/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                    <i class="fas fa-envelope mr-3"></i>
                    お問い合わせ一覧
                </a>
                
                <!-- システム管理 -->
                <div class="mt-6">
                    <p class="px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">システム管理</p>
                    <a href="access.html" class="flex items-center px-6 py-3 bg-slate-700 text-white border-r-2 border-blue-500">
                        <i class="fas fa-history mr-3"></i>
                        アクセスログ
                    </a>
                    <a href="actions.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-clipboard-list mr-3"></i>
                        操作ログ
                    </a>
                    <a href="../backup/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-database mr-3"></i>
                        バックアップ
                    </a>
                    <a href="../api/keys.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-key mr-3"></i>
                        API管理
                    </a>
                    <a href="../help/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-question-circle mr-3"></i>
                        ヘルプ
                    </a>
                </div>
                
                <!-- ログアウト -->
                <div class="absolute bottom-4 left-0 right-0 px-6">
                    <a href="../../public/login.html" class="flex items-center text-slate-300 hover:text-white transition-colors">
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        ログアウト
                    </a>
                </div>
            </nav>
        </aside>

        <!-- メインコンテンツ -->
        <main class="ml-64 flex-1 p-8">
            <!-- ヘッダー -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-history text-blue-600 mr-3"></i>
                        アクセスログ
                    </h1>
                    <p class="text-gray-600 mt-2">システムへのアクセス履歴を監視・分析</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">admin@example.com</span>
                    <span class="text-sm text-gray-500">最終更新: <span id="lastUpdated">--:--</span></span>
                </div>
            </div>

            <!-- 統計カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">本日のアクセス</p>
                            <p class="text-2xl font-bold text-gray-900" id="todayAccess">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-globe text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">ユニークIP</p>
                            <p class="text-2xl font-bold text-gray-900" id="uniqueIPs">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                            <i class="fas fa-exclamation-triangle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">異常アクセス</p>
                            <p class="text-2xl font-bold text-gray-900" id="suspiciousAccess">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">平均レスポンス</p>
                            <p class="text-2xl font-bold text-gray-900" id="avgResponse">0ms</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- アクセス傾向グラフ -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        アクセス傾向
                    </h2>
                    <div class="flex space-x-2">
                        <select id="chartPeriod" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="24h">過去24時間</option>
                            <option value="7d">過去7日間</option>
                            <option value="30d">過去30日間</option>
                        </select>
                    </div>
                </div>
                <canvas id="accessTrendChart" width="400" height="150"></canvas>
            </div>

            <!-- 検索・フィルター -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">IPアドレス</label>
                        <input type="text" id="filterIP" placeholder="192.168.1.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ユーザー</label>
                        <select id="filterUser" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">すべてのユーザー</option>
                            <option value="admin@example.com">admin@example.com</option>
                            <option value="user@example.com">user@example.com</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日時</label>
                        <input type="datetime-local" id="filterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">終了日時</label>
                        <input type="datetime-local" id="filterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <div class="flex space-x-2">
                        <button id="applyFilters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                        <button id="resetFilters" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>リセット
                        </button>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="exportLogs" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>エクスポート
                        </button>
                        <button id="refreshLogs" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>更新
                        </button>
                    </div>
                </div>
            </div>

            <!-- アクセスログテーブル -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-list text-blue-600 mr-2"></i>
                        アクセスログ一覧
                    </h2>
                    <p class="text-sm text-gray-600">システムへのアクセス記録を時系列で表示</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="created_at">
                                    日時 <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="user_email">
                                    ユーザー <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ip_address">
                                    IPアドレス <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    URL
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="method">
                                    メソッド <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="status_code">
                                    ステータス <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="response_time">
                                    レスポンス時間 <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- ローディング表示 -->
                            <tr id="loadingRow">
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                                        <p class="text-gray-500">アクセスログを読み込んでいます...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- ページネーション -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            前へ
                        </button>
                        <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            次へ
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                全 <span id="totalRecords" class="font-medium">0</span> 件中 
                                <span id="recordRange" class="font-medium">0 - 0</span> 件を表示
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="pagination">
                                <!-- ページネーションボタンがここに動的に生成される -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 詳細モーダル -->
    <div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full m-4 max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    アクセス詳細
                </h3>
                <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="px-6 py-4" id="detailModalContent">
                <!-- 詳細情報がここに表示される -->
            </div>
        </div>
    </div>

    <script>
        class AccessLogManager {
            constructor() {
                this.currentPage = 1;
                this.pageSize = 20;
                this.accessLogs = [];
                this.filteredLogs = [];
                this.sortConfig = { key: 'created_at', direction: 'desc' };
                this.chart = null;
                
                this.init();
            }
            
            async init() {
                this.setupEventListeners();
                await this.loadAccessLogs();
                this.renderChart();
                this.updateLastUpdated();
                
                // 自動更新（30秒ごと）
                setInterval(() => {
                    this.loadAccessLogs();
                    this.updateLastUpdated();
                }, 30000);
            }
            
            setupEventListeners() {
                // フィルター関連
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('resetFilters').addEventListener('click', () => this.resetFilters());
                document.getElementById('refreshLogs').addEventListener('click', () => this.loadAccessLogs());
                document.getElementById('exportLogs').addEventListener('click', () => this.exportLogs());
                
                // チャート期間変更
                document.getElementById('chartPeriod').addEventListener('change', () => this.renderChart());
                
                // ソート
                document.querySelectorAll('[data-sort]').forEach(header => {
                    header.addEventListener('click', () => {
                        const key = header.dataset.sort;
                        this.sortLogs(key);
                    });
                });
                
                // モーダル
                document.getElementById('closeDetailModal').addEventListener('click', () => {
                    document.getElementById('detailModal').classList.add('hidden');
                });
            }
            
            async loadAccessLogs() {
                try {
                    // サンプルデータ（実際のSupabase実装時に置き換え）
                    this.accessLogs = this.generateSampleAccessLogs();
                    this.filteredLogs = [...this.accessLogs];
                    
                    this.renderTable();
                    this.updateStatistics();
                    this.updatePagination();
                    
                } catch (error) {
                    console.error('アクセスログの読み込みに失敗:', error);
                    this.showError('アクセスログの読み込みに失敗しました。');
                }
            }
            
            generateSampleAccessLogs() {
                const logs = [];
                const users = ['admin@example.com', 'user@example.com', 'manager@example.com'];
                const ips = ['192.168.1.100', '10.0.0.50', '172.16.0.25', '203.0.113.10'];
                const urls = ['/admin/index.html', '/admin/contacts/', '/admin/api/keys.html', '/admin/backup/', '/public/login.html'];
                const methods = ['GET', 'POST', 'PUT', 'DELETE'];
                const statusCodes = [200, 201, 400, 401, 404, 500];
                const userAgents = [
                    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
                ];
                
                for (let i = 0; i < 150; i++) {
                    const date = new Date();
                    date.setHours(date.getHours() - Math.floor(Math.random() * 168)); // 過去1週間
                    
                    logs.push({
                        id: `log_${i + 1}`,
                        created_at: date.toISOString(),
                        user_email: users[Math.floor(Math.random() * users.length)],
                        ip_address: ips[Math.floor(Math.random() * ips.length)],
                        user_agent: userAgents[Math.floor(Math.random() * userAgents.length)],
                        url: urls[Math.floor(Math.random() * urls.length)],
                        method: methods[Math.floor(Math.random() * methods.length)],
                        status_code: statusCodes[Math.floor(Math.random() * statusCodes.length)],
                        response_time: Math.floor(Math.random() * 2000) + 50 // 50-2050ms
                    });
                }
                
                return logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            applyFilters() {
                const ipFilter = document.getElementById('filterIP').value.trim();
                const userFilter = document.getElementById('filterUser').value;
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;
                
                this.filteredLogs = this.accessLogs.filter(log => {
                    let match = true;
                    
                    if (ipFilter && !log.ip_address.includes(ipFilter)) {
                        match = false;
                    }
                    
                    if (userFilter && log.user_email !== userFilter) {
                        match = false;
                    }
                    
                    if (startDate && new Date(log.created_at) < new Date(startDate)) {
                        match = false;
                    }
                    
                    if (endDate && new Date(log.created_at) > new Date(endDate)) {
                        match = false;
                    }
                    
                    return match;
                });
                
                this.currentPage = 1;
                this.renderTable();
                this.updateStatistics();
                this.updatePagination();
            }
            
            resetFilters() {
                document.getElementById('filterIP').value = '';
                document.getElementById('filterUser').value = '';
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
                
                this.filteredLogs = [...this.accessLogs];
                this.currentPage = 1;
                this.renderTable();
                this.updateStatistics();
                this.updatePagination();
            }
            
            sortLogs(key) {
                if (this.sortConfig.key === key) {
                    this.sortConfig.direction = this.sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortConfig.key = key;
                    this.sortConfig.direction = 'asc';
                }
                
                this.filteredLogs.sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];
                    
                    if (key === 'created_at') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return this.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                this.renderTable();
                this.updateSortIcons();
            }
            
            updateSortIcons() {
                document.querySelectorAll('[data-sort] i').forEach(icon => {
                    icon.className = 'fas fa-sort ml-1';
                });
                
                const activeHeader = document.querySelector(`[data-sort="${this.sortConfig.key}"] i`);
                if (activeHeader) {
                    activeHeader.className = `fas fa-sort-${this.sortConfig.direction === 'asc' ? 'up' : 'down'} ml-1`;
                }
            }
            
            renderTable() {
                const tbody = document.getElementById('logsTableBody');
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const pageData = this.filteredLogs.slice(startIndex, endIndex);
                
                if (pageData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                                <p>条件に一致するアクセスログが見つかりません</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = pageData.map(log => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${this.formatDateTime(log.created_at)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                ${log.user_email}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${log.ip_address}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${log.url}">
                            ${log.url}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getMethodColor(log.method)}">
                                ${log.method}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(log.status_code)}">
                                ${log.status_code}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${log.response_time}ms
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="accessLogManager.showLogDetail('${log.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            getMethodColor(method) {
                const colors = {
                    'GET': 'bg-green-100 text-green-800',
                    'POST': 'bg-blue-100 text-blue-800',
                    'PUT': 'bg-yellow-100 text-yellow-800',
                    'DELETE': 'bg-red-100 text-red-800'
                };
                return colors[method] || 'bg-gray-100 text-gray-800';
            }
            
            getStatusColor(status) {
                if (status >= 200 && status < 300) return 'bg-green-100 text-green-800';
                if (status >= 300 && status < 400) return 'bg-yellow-100 text-yellow-800';
                if (status >= 400 && status < 500) return 'bg-orange-100 text-orange-800';
                if (status >= 500) return 'bg-red-100 text-red-800';
                return 'bg-gray-100 text-gray-800';
            }
            
            updateStatistics() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayLogs = this.filteredLogs.filter(log => new Date(log.created_at) >= today);
                const uniqueIPs = new Set(this.filteredLogs.map(log => log.ip_address)).size;
                const suspiciousLogs = this.filteredLogs.filter(log => log.status_code >= 400).length;
                const avgResponse = Math.round(this.filteredLogs.reduce((sum, log) => sum + log.response_time, 0) / this.filteredLogs.length) || 0;
                
                document.getElementById('todayAccess').textContent = todayLogs.length;
                document.getElementById('uniqueIPs').textContent = uniqueIPs;
                document.getElementById('suspiciousAccess').textContent = suspiciousLogs;
                document.getElementById('avgResponse').textContent = `${avgResponse}ms`;
            }
            
            updatePagination() {
                const totalPages = Math.ceil(this.filteredLogs.length / this.pageSize);
                const startRecord = (this.currentPage - 1) * this.pageSize + 1;
                const endRecord = Math.min(this.currentPage * this.pageSize, this.filteredLogs.length);
                
                document.getElementById('totalRecords').textContent = this.filteredLogs.length;
                document.getElementById('recordRange').textContent = `${startRecord} - ${endRecord}`;
                
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = this.generatePaginationHTML(totalPages);
            }
            
            generatePaginationHTML(totalPages) {
                if (totalPages <= 1) return '';
                
                let html = '';
                
                // 前へボタン
                html += `
                    <button onclick="accessLogManager.changePage(${this.currentPage - 1})" 
                            ${this.currentPage === 1 ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
                
                // ページ番号
                for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                    const isActive = i === this.currentPage;
                    html += `
                        <button onclick="accessLogManager.changePage(${i})" 
                                class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isActive ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}">
                            ${i}
                        </button>
                    `;
                }
                
                // 次へボタン  
                html += `
                    <button onclick="accessLogManager.changePage(${this.currentPage + 1})" 
                            ${this.currentPage === totalPages ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
                
                return html;
            }
            
            changePage(page) {
                const totalPages = Math.ceil(this.filteredLogs.length / this.pageSize);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderTable();
                    this.updatePagination();
                }
            }
            
            renderChart() {
                const period = document.getElementById('chartPeriod').value;
                const ctx = document.getElementById('accessTrendChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const chartData = this.generateChartData(period);
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'アクセス数',
                            data: chartData.data,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
            
            generateChartData(period) {
                const now = new Date();
                const labels = [];
                const data = [];
                
                if (period === '24h') {
                    // 過去24時間を1時間ごと
                    for (let i = 23; i >= 0; i--) {
                        const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
                        labels.push(hour.getHours() + ':00');
                        
                        const hourLogs = this.accessLogs.filter(log => {
                            const logTime = new Date(log.created_at);
                            return logTime.getHours() === hour.getHours() &&
                                   logTime.getDate() === hour.getDate();
                        });
                        data.push(hourLogs.length);
                    }
                } else if (period === '7d') {
                    // 過去7日間を1日ごと
                    for (let i = 6; i >= 0; i--) {
                        const day = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        labels.push(`${day.getMonth() + 1}/${day.getDate()}`);
                        
                        const dayLogs = this.accessLogs.filter(log => {
                            const logTime = new Date(log.created_at);
                            return logTime.getDate() === day.getDate() &&
                                   logTime.getMonth() === day.getMonth();
                        });
                        data.push(dayLogs.length);
                    }
                } else {
                    // 過去30日間を1日ごと
                    for (let i = 29; i >= 0; i--) {
                        const day = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        labels.push(`${day.getMonth() + 1}/${day.getDate()}`);
                        
                        const dayLogs = this.accessLogs.filter(log => {
                            const logTime = new Date(log.created_at);
                            return logTime.getDate() === day.getDate() &&
                                   logTime.getMonth() === day.getMonth();
                        });
                        data.push(dayLogs.length);
                    }
                }
                
                return { labels, data };
            }
            
            showLogDetail(logId) {
                const log = this.accessLogs.find(l => l.id === logId);
                if (!log) return;
                
                const modalContent = document.getElementById('detailModalContent');
                modalContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">基本情報</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">アクセス日時</dt>
                                    <dd class="text-sm text-gray-900">${this.formatDateTime(log.created_at)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ユーザー</dt>
                                    <dd class="text-sm text-gray-900">${log.user_email}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">IPアドレス</dt>
                                    <dd class="text-sm text-gray-900">${log.ip_address}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">リクエストURL</dt>
                                    <dd class="text-sm text-gray-900 break-all">${log.url}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">HTTPメソッド</dt>
                                    <dd class="text-sm text-gray-900">${log.method}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">レスポンス情報</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ステータスコード</dt>
                                    <dd class="text-sm text-gray-900">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(log.status_code)}">
                                            ${log.status_code}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">レスポンス時間</dt>
                                    <dd class="text-sm text-gray-900">${log.response_time}ms</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ユーザーエージェント</dt>
                                    <dd class="text-sm text-gray-900 break-all">${log.user_agent}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">セキュリティ分析</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-shield-alt text-green-500 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <h5 class="text-sm font-medium text-gray-900">リスク評価: 低</h5>
                                    <p class="text-sm text-gray-600 mt-1">
                                        このアクセスは正常なパターンです。異常な活動は検出されていません。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('detailModal').classList.remove('hidden');
            }
            
            exportLogs() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `access_logs_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            generateCSV() {
                const headers = ['日時', 'ユーザー', 'IPアドレス', 'URL', 'メソッド', 'ステータス', 'レスポンス時間', 'ユーザーエージェント'];
                const rows = this.filteredLogs.map(log => [
                    this.formatDateTime(log.created_at),
                    log.user_email,
                    log.ip_address,
                    log.url,
                    log.method,
                    log.status_code,
                    `${log.response_time}ms`,
                    log.user_agent
                ]);
                
                return [headers, ...rows].map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }
            
            formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            updateLastUpdated() {
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            showError(message) {
                // エラー表示の実装
                console.error(message);
            }
        }
        
        // アプリケーション初期化
        let accessLogManager;
        document.addEventListener('DOMContentLoaded', () => {
            accessLogManager = new AccessLogManager();
        });
    </script>
    
    <script src="/admin/assets/js/mobile-menu.js"></script>
</body>
</html>