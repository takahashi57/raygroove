<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作ログ - お問い合わせ管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- サイドバー -->
    <div class="flex">
        <aside class="w-64 bg-slate-800 text-white min-h-screen fixed left-0 top-0 z-10">
            <!-- ヘッダー -->
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold">管理画面</h1>
                <p class="text-sm text-slate-400">お問い合わせ管理システム</p>
            </div>
            
            <!-- ナビゲーション -->
            <nav class="mt-6">
                <a href="../index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    ダッシュボード
                </a>
                <a href="../contacts/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                    <i class="fas fa-envelope mr-3"></i>
                    お問い合わせ一覧
                </a>
                
                <!-- システム管理 -->
                <div class="mt-6">
                    <p class="px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">システム管理</p>
                    <a href="access.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-history mr-3"></i>
                        アクセスログ
                    </a>
                    <a href="actions.html" class="flex items-center px-6 py-3 bg-slate-700 text-white border-r-2 border-blue-500">
                        <i class="fas fa-clipboard-list mr-3"></i>
                        操作ログ
                    </a>
                    <a href="../backup/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-database mr-3"></i>
                        バックアップ
                    </a>
                    <a href="../api/keys.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-key mr-3"></i>
                        API管理
                    </a>
                    <a href="../help/index.html" class="flex items-center px-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fas fa-question-circle mr-3"></i>
                        ヘルプ
                    </a>
                </div>
                
                <!-- ログアウト -->
                <div class="absolute bottom-4 left-0 right-0 px-6">
                    <a href="../../public/login.html" class="flex items-center text-slate-300 hover:text-white transition-colors">
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        ログアウト
                    </a>
                </div>
            </nav>
        </aside>

        <!-- メインコンテンツ -->
        <main class="ml-64 flex-1 p-8">
            <!-- ヘッダー -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-clipboard-list text-blue-600 mr-3"></i>
                        操作ログ
                    </h1>
                    <p class="text-sm text-gray-600">システム内で実行された全操作の詳細記録</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="created_at">
                                    日時 <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="user_email">
                                    操作者 <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="action_type">
                                    操作種別 <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="table_name">
                                    対象テーブル <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    レコードID
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    変更内容
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- ローディング表示 -->
                            <tr id="loadingRow">
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                                        <p class="text-gray-500">操作ログを読み込んでいます...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- ページネーション -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            前へ
                        </button>
                        <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                            次へ
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                全 <span id="totalRecords" class="font-medium">0</span> 件中 
                                <span id="recordRange" class="font-medium">0 - 0</span> 件を表示
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="pagination">
                                <!-- ページネーションボタンがここに動的に生成される -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 詳細モーダル -->
    <div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full m-4 max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    操作詳細
                </h3>
                <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="px-6 py-4" id="detailModalContent">
                <!-- 詳細情報がここに表示される -->
            </div>
        </div>
    </div>

    <!-- ロールバック確認モーダル -->
    <div id="rollbackModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full m-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-red-900">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    ロールバック確認
                </h3>
            </div>
            
            <div class="px-6 py-4">
                <p class="text-gray-700 mb-4">この操作をロールバック（取り消し）しますか？</p>
                <p class="text-sm text-red-600 mb-4">
                    <i class="fas fa-warning mr-1"></i>
                    この操作は取り消せません。慎重に実行してください。
                </p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelRollback" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        キャンセル
                    </button>
                    <button id="confirmRollback" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        ロールバック実行
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ActionLogManager {
            constructor() {
                this.currentPage = 1;
                this.pageSize = 20;
                this.actionLogs = [];
                this.filteredLogs = [];
                this.sortConfig = { key: 'created_at', direction: 'desc' };
                this.chart = null;
                this.selectedLogId = null;
                
                this.init();
            }
            
            async init() {
                this.setupEventListeners();
                await this.loadActionLogs();
                this.renderChart();
                this.updateLastUpdated();
                
                // 自動更新（60秒ごと）
                setInterval(() => {
                    this.loadActionLogs();
                    this.updateLastUpdated();
                }, 60000);
            }
            
            setupEventListeners() {
                // フィルター関連
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('resetFilters').addEventListener('click', () => this.resetFilters());
                document.getElementById('refreshLogs').addEventListener('click', () => this.loadActionLogs());
                document.getElementById('exportLogs').addEventListener('click', () => this.exportLogs());
                
                // チャート期間変更
                document.getElementById('chartPeriod').addEventListener('change', () => this.renderChart());
                
                // ソート
                document.querySelectorAll('[data-sort]').forEach(header => {
                    header.addEventListener('click', () => {
                        const key = header.dataset.sort;
                        this.sortLogs(key);
                    });
                });
                
                // モーダル関連
                document.getElementById('closeDetailModal').addEventListener('click', () => {
                    document.getElementById('detailModal').classList.add('hidden');
                });
                
                document.getElementById('cancelRollback').addEventListener('click', () => {
                    document.getElementById('rollbackModal').classList.add('hidden');
                });
                
                document.getElementById('confirmRollback').addEventListener('click', () => {
                    this.executeRollback();
                });
            }
            
            async loadActionLogs() {
                try {
                    // サンプルデータ（実際のSupabase実装時に置き換え）
                    this.actionLogs = this.generateSampleActionLogs();
                    this.filteredLogs = [...this.actionLogs];
                    
                    this.renderTable();
                    this.updateStatistics();
                    this.updatePagination();
                    
                } catch (error) {
                    console.error('操作ログの読み込みに失敗:', error);
                    this.showError('操作ログの読み込みに失敗しました。');
                }
            }
            
            generateSampleActionLogs() {
                const logs = [];
                const users = ['admin@example.com', 'user@example.com', 'manager@example.com'];
                const actions = ['create', 'update', 'delete', 'login', 'export'];
                const tables = ['contacts', 'api_keys', 'backups', 'users'];
                const ips = ['192.168.1.100', '10.0.0.50', '172.16.0.25'];
                
                for (let i = 0; i < 100; i++) {
                    const date = new Date();
                    date.setHours(date.getHours() - Math.floor(Math.random() * 168)); // 過去1週間
                    
                    const actionType = actions[Math.floor(Math.random() * actions.length)];
                    const tableName = tables[Math.floor(Math.random() * tables.length)];
                    const recordId = `record_${Math.floor(Math.random() * 1000)}`;
                    
                    // サンプルの変更データ
                    const oldValues = actionType === 'create' ? null : {
                        name: '田中太郎',
                        email: 'tanaka@example.com',
                        status: 'pending'
                    };
                    
                    const newValues = actionType === 'delete' ? null : {
                        name: '田中太郎',
                        email: 'tanaka.updated@example.com',
                        status: 'completed'
                    };
                    
                    logs.push({
                        id: `action_${i + 1}`,
                        created_at: date.toISOString(),
                        user_email: users[Math.floor(Math.random() * users.length)],
                        action_type: actionType,
                        table_name: tableName,
                        record_id: recordId,
                        old_values: oldValues,
                        new_values: newValues,
                        ip_address: ips[Math.floor(Math.random() * ips.length)],
                        user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    });
                }
                
                return logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            applyFilters() {
                const userFilter = document.getElementById('filterUser').value;
                const actionFilter = document.getElementById('filterAction').value;
                const tableFilter = document.getElementById('filterTable').value;
                const dateFilter = document.getElementById('filterDate').value;
                
                this.filteredLogs = this.actionLogs.filter(log => {
                    let match = true;
                    
                    if (userFilter && log.user_email !== userFilter) {
                        match = false;
                    }
                    
                    if (actionFilter && log.action_type !== actionFilter) {
                        match = false;
                    }
                    
                    if (tableFilter && log.table_name !== tableFilter) {
                        match = false;
                    }
                    
                    if (dateFilter) {
                        const logDate = new Date(log.created_at).toDateString();
                        const filterDate = new Date(dateFilter).toDateString();
                        if (logDate !== filterDate) {
                            match = false;
                        }
                    }
                    
                    return match;
                });
                
                this.currentPage = 1;
                this.renderTable();
                this.updateStatistics();
                this.updatePagination();
            }
            
            resetFilters() {
                document.getElementById('filterUser').value = '';
                document.getElementById('filterAction').value = '';
                document.getElementById('filterTable').value = '';
                document.getElementById('filterDate').value = '';
                
                this.filteredLogs = [...this.actionLogs];
                this.currentPage = 1;
                this.renderTable();
                this.updateStatistics();
                this.updatePagination();
            }
            
            sortLogs(key) {
                if (this.sortConfig.key === key) {
                    this.sortConfig.direction = this.sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortConfig.key = key;
                    this.sortConfig.direction = 'asc';
                }
                
                this.filteredLogs.sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];
                    
                    if (key === 'created_at') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return this.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                this.renderTable();
                this.updateSortIcons();
            }
            
            updateSortIcons() {
                document.querySelectorAll('[data-sort] i').forEach(icon => {
                    icon.className = 'fas fa-sort ml-1';
                });
                
                const activeHeader = document.querySelector(`[data-sort="${this.sortConfig.key}"] i`);
                if (activeHeader) {
                    activeHeader.className = `fas fa-sort-${this.sortConfig.direction === 'asc' ? 'up' : 'down'} ml-1`;
                }
            }
            
            renderTable() {
                const tbody = document.getElementById('logsTableBody');
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const pageData = this.filteredLogs.slice(startIndex, endIndex);
                
                if (pageData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                                <p>条件に一致する操作ログが見つかりません</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = pageData.map(log => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${this.formatDateTime(log.created_at)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                ${log.user_email}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getActionColor(log.action_type)}">
                                <i class="fas ${this.getActionIcon(log.action_type)} mr-1"></i>
                                ${this.getActionLabel(log.action_type)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                ${log.table_name}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                            ${log.record_id}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            ${this.getChangesSummary(log)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="actionLogManager.showLogDetail('${log.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="詳細表示">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${log.action_type !== 'delete' ? `
                                <button onclick="actionLogManager.showRollbackModal('${log.id}')" class="text-red-600 hover:text-red-900" title="ロールバック">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            }
            
            getActionColor(action) {
                const colors = {
                    'create': 'bg-green-100 text-green-800',
                    'update': 'bg-blue-100 text-blue-800',
                    'delete': 'bg-red-100 text-red-800',
                    'login': 'bg-purple-100 text-purple-800',
                    'export': 'bg-orange-100 text-orange-800'
                };
                return colors[action] || 'bg-gray-100 text-gray-800';
            }
            
            getActionIcon(action) {
                const icons = {
                    'create': 'fa-plus',
                    'update': 'fa-edit',
                    'delete': 'fa-trash',
                    'login': 'fa-sign-in-alt',
                    'export': 'fa-download'
                };
                return icons[action] || 'fa-question';
            }
            
            getActionLabel(action) {
                const labels = {
                    'create': '作成',
                    'update': '更新',
                    'delete': '削除',
                    'login': 'ログイン',
                    'export': 'エクスポート'
                };
                return labels[action] || action;
            }
            
            getChangesSummary(log) {
                if (log.action_type === 'create') {
                    return '新規レコード作成';
                } else if (log.action_type === 'delete') {
                    return 'レコード削除';
                } else if (log.old_values && log.new_values) {
                    const changes = [];
                    for (const key in log.new_values) {
                        if (log.old_values[key] !== log.new_values[key]) {
                            changes.push(key);
                        }
                    }
                    return changes.length > 0 ? `${changes.join(', ')} を変更` : '変更なし';
                }
                return '詳細不明';
            }
            
            updateStatistics() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayLogs = this.filteredLogs.filter(log => new Date(log.created_at) >= today);
                const createLogs = this.filteredLogs.filter(log => log.action_type === 'create');
                const updateLogs = this.filteredLogs.filter(log => log.action_type === 'update');
                const deleteLogs = this.filteredLogs.filter(log => log.action_type === 'delete');
                
                document.getElementById('todayActions').textContent = todayLogs.length;
                document.getElementById('createActions').textContent = createLogs.length;
                document.getElementById('updateActions').textContent = updateLogs.length;
                document.getElementById('deleteActions').textContent = deleteLogs.length;
            }
            
            updatePagination() {
                const totalPages = Math.ceil(this.filteredLogs.length / this.pageSize);
                const startRecord = (this.currentPage - 1) * this.pageSize + 1;
                const endRecord = Math.min(this.currentPage * this.pageSize, this.filteredLogs.length);
                
                document.getElementById('totalRecords').textContent = this.filteredLogs.length;
                document.getElementById('recordRange').textContent = `${startRecord} - ${endRecord}`;
                
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = this.generatePaginationHTML(totalPages);
            }
            
            generatePaginationHTML(totalPages) {
                if (totalPages <= 1) return '';
                
                let html = '';
                
                // 前へボタン
                html += `
                    <button onclick="actionLogManager.changePage(${this.currentPage - 1})" 
                            ${this.currentPage === 1 ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
                
                // ページ番号
                for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                    const isActive = i === this.currentPage;
                    html += `
                        <button onclick="actionLogManager.changePage(${i})" 
                                class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isActive ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}">
                            ${i}
                        </button>
                    `;
                }
                
                // 次へボタン  
                html += `
                    <button onclick="actionLogManager.changePage(${this.currentPage + 1})" 
                            ${this.currentPage === totalPages ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
                
                return html;
            }
            
            changePage(page) {
                const totalPages = Math.ceil(this.filteredLogs.length / this.pageSize);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderTable();
                    this.updatePagination();
                }
            }
            
            renderChart() {
                const period = document.getElementById('chartPeriod').value;
                const ctx = document.getElementById('actionTrendChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const chartData = this.generateChartData(period);
                
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: '作成',
                            data: chartData.create,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }, {
                            label: '更新',
                            data: chartData.update,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }, {
                            label: '削除',
                            data: chartData.delete,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                stacked: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                stacked: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
            
            generateChartData(period) {
                const now = new Date();
                const labels = [];
                const create = [];
                const update = [];
                const deleteData = [];
                
                let days = 7;
                if (period === '30d') days = 30;
                else if (period === '90d') days = 90;
                
                for (let i = days - 1; i >= 0; i--) {
                    const day = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                    labels.push(`${day.getMonth() + 1}/${day.getDate()}`);
                    
                    const dayLogs = this.actionLogs.filter(log => {
                        const logTime = new Date(log.created_at);
                        return logTime.getDate() === day.getDate() &&
                               logTime.getMonth() === day.getMonth();
                    });
                    
                    create.push(dayLogs.filter(log => log.action_type === 'create').length);
                    update.push(dayLogs.filter(log => log.action_type === 'update').length);
                    deleteData.push(dayLogs.filter(log => log.action_type === 'delete').length);
                }
                
                return { labels, create, update, delete: deleteData };
            }
            
            showLogDetail(logId) {
                const log = this.actionLogs.find(l => l.id === logId);
                if (!log) return;
                
                const modalContent = document.getElementById('detailModalContent');
                modalContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">操作情報</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">操作日時</dt>
                                    <dd class="text-sm text-gray-900">${this.formatDateTime(log.created_at)}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">操作者</dt>
                                    <dd class="text-sm text-gray-900">${log.user_email}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">IPアドレス</dt>
                                    <dd class="text-sm text-gray-900">${log.ip_address}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">操作種別</dt>
                                    <dd class="text-sm">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getActionColor(log.action_type)}">
                                            <i class="fas ${this.getActionIcon(log.action_type)} mr-1"></i>
                                            ${this.getActionLabel(log.action_type)}
                                        </span>
                                    </dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">対象テーブル</dt>
                                    <dd class="text-sm text-gray-900">${log.table_name}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">レコードID</dt>
                                    <dd class="text-sm text-gray-900 font-mono">${log.record_id}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">変更内容</h4>
                            ${this.renderChangesDetail(log)}
                        </div>
                    </div>
                `;
                
                document.getElementById('detailModal').classList.remove('hidden');
            }
            
            renderChangesDetail(log) {
                if (log.action_type === 'create') {
                    return `
                        <div class="bg-green-50 rounded-lg p-4">
                            <h5 class="text-sm font-medium text-green-900 mb-2">新規作成されたデータ</h5>
                            <pre class="text-xs text-green-800 bg-green-100 p-3 rounded overflow-x-auto">${JSON.stringify(log.new_values, null, 2)}</pre>
                        </div>
                    `;
                } else if (log.action_type === 'delete') {
                    return `
                        <div class="bg-red-50 rounded-lg p-4">
                            <h5 class="text-sm font-medium text-red-900 mb-2">削除されたデータ</h5>
                            <pre class="text-xs text-red-800 bg-red-100 p-3 rounded overflow-x-auto">${JSON.stringify(log.old_values, null, 2)}</pre>
                        </div>
                    `;
                } else if (log.old_values && log.new_values) {
                    return `
                        <div class="space-y-4">
                            <div class="bg-red-50 rounded-lg p-4">
                                <h5 class="text-sm font-medium text-red-900 mb-2">変更前</h5>
                                <pre class="text-xs text-red-800 bg-red-100 p-3 rounded overflow-x-auto">${JSON.stringify(log.old_values, null, 2)}</pre>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <h5 class="text-sm font-medium text-green-900 mb-2">変更後</h5>
                                <pre class="text-xs text-green-800 bg-green-100 p-3 rounded overflow-x-auto">${JSON.stringify(log.new_values, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
                return '<p class="text-gray-500">変更内容の詳細が記録されていません。</p>';
            }
            
            showRollbackModal(logId) {
                this.selectedLogId = logId;
                document.getElementById('rollbackModal').classList.remove('hidden');
            }
            
            async executeRollback() {
                if (!this.selectedLogId) return;
                
                const log = this.actionLogs.find(l => l.id === this.selectedLogId);
                if (!log) return;
                
                try {
                    // ここで実際のロールバック処理を実装
                    // Supabaseのデータを元に戻す処理
                    console.log('ロールバック実行:', log);
                    
                    // 成功メッセージ
                    this.showSuccess('ロールバックが完了しました。');
                    
                    // モーダルを閉じる
                    document.getElementById('rollbackModal').classList.add('hidden');
                    
                    // データを再読み込み
                    await this.loadActionLogs();
                    
                } catch (error) {
                    console.error('ロールバック失敗:', error);
                    this.showError('ロールバックに失敗しました。');
                }
            }
            
            exportLogs() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `action_logs_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            generateCSV() {
                const headers = ['日時', '操作者', '操作種別', '対象テーブル', 'レコードID', 'IPアドレス', '変更内容'];
                const rows = this.filteredLogs.map(log => [
                    this.formatDateTime(log.created_at),
                    log.user_email,
                    this.getActionLabel(log.action_type),
                    log.table_name,
                    log.record_id,
                    log.ip_address,
                    this.getChangesSummary(log)
                ]);
                
                return [headers, ...rows].map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }
            
            formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            updateLastUpdated() {
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            showError(message) {
                // エラー表示の実装
                console.error(message);
            }
            
            showSuccess(message) {
                // 成功メッセージの実装
                console.log(message);
            }
        }
        
        // アプリケーション初期化
        let actionLogManager;
        document.addEventListener('DOMContentLoaded', () => {
            actionLogManager = new ActionLogManager();
        });
    </script>
</body>
</html>gray-600 mt-2">システム内の全操作記録を監査・追跡</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">admin@example.com</span>
                    <span class="text-sm text-gray-500">最終更新: <span id="lastUpdated">--:--</span></span>
                </div>
            </div>

            <!-- 統計カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-edit text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">本日の操作</p>
                            <p class="text-2xl font-bold text-gray-900" id="todayActions">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-plus text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">新規作成</p>
                            <p class="text-2xl font-bold text-gray-900" id="createActions">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                            <i class="fas fa-pencil-alt text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">更新</p>
                            <p class="text-2xl font-bold text-gray-900" id="updateActions">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-trash text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">削除</p>
                            <p class="text-2xl font-bold text-gray-900" id="deleteActions">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作傾向グラフ -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                        操作傾向
                    </h2>
                    <div class="flex space-x-2">
                        <select id="chartPeriod" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="7d">過去7日間</option>
                            <option value="30d">過去30日間</option>
                            <option value="90d">過去90日間</option>
                        </select>
                    </div>
                </div>
                <canvas id="actionTrendChart" width="400" height="150"></canvas>
            </div>

            <!-- 検索・フィルター -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">操作者</label>
                        <select id="filterUser" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">すべてのユーザー</option>
                            <option value="admin@example.com">admin@example.com</option>
                            <option value="user@example.com">user@example.com</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">操作種別</label>
                        <select id="filterAction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">すべての操作</option>
                            <option value="create">作成</option>
                            <option value="update">更新</option>
                            <option value="delete">削除</option>
                            <option value="login">ログイン</option>
                            <option value="export">エクスポート</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">対象テーブル</label>
                        <select id="filterTable" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">すべてのテーブル</option>
                            <option value="contacts">お問い合わせ</option>
                            <option value="api_keys">APIキー</option>
                            <option value="backups">バックアップ</option>
                            <option value="users">ユーザー</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">日付範囲</label>
                        <input type="date" id="filterDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <div class="flex space-x-2">
                        <button id="applyFilters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                        <button id="resetFilters" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>リセット
                        </button>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="exportLogs" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>エクスポート
                        </button>
                        <button id="refreshLogs" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>更新
                        </button>
                    </div>
                </div>
            </div>

            <!-- 操作ログテーブル -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-list text-blue-600 mr-2"></i>
                        操作ログ一覧
                    </h2>
                    <p class="text-