<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API管理 - お問い合わせ管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .api-card {
            transition: all 0.3s ease;
        }
        .api-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .api-key-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f3f4f6;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            user-select: all;
        }
        .usage-chart {
            height: 200px;
        }
        .rate-limit-bar {
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }
        .rate-limit-progress {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .status-indicator {
            position: relative;
        }
        .status-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -10px;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-active::before {
            background-color: #10b981;
        }
        .status-inactive::before {
            background-color: #ef4444;
        }
        .status-suspended::before {
            background-color: #f59e0b;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .copy-button {
            transition: all 0.2s ease;
        }
        .copy-button:hover {
            background-color: #3b82f6;
            color: white;
        }
        .api-stats-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- エラー通知バナー -->
    <div id="error-banner" class="hidden fixed top-0 left-0 right-0 bg-red-500 text-white px-4 py-2 text-center z-50">
        <span id="error-message"></span>
        <button onclick="hideErrorBanner()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- 成功通知バナー -->
    <div id="success-banner" class="hidden fixed top-0 left-0 right-0 bg-green-500 text-white px-4 py-2 text-center z-50">
        <span id="success-message"></span>
        <button onclick="hideSuccessBanner()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="flex h-screen">
        <!-- サイドバー -->
        <div class="w-64 bg-gray-800 text-white">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">管理画面</h1>
                <p class="text-sm text-gray-400">お問い合わせ管理システム</p>
            </div>
            <nav class="mt-4">
                <a href="../index.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-tachometer-alt mr-3"></i> ダッシュボード
                </a>
                <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                    システム管理
                </div>
                <a href="../logs/access.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-chart-line mr-3"></i> アクセスログ
                </a>
                <a href="../logs/actions.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-history mr-3"></i> 操作ログ
                </a>
                <a href="../backup/index.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-hdd mr-3"></i> バックアップ
                </a>
                <a href="keys.html" class="flex items-center px-4 py-3 text-white bg-gray-700">
                    <i class="fas fa-key mr-3"></i> API管理
                </a>
                <a href="../help/" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-question-circle mr-3"></i> ヘルプ
                </a>
            </nav>
        </div>

        <!-- メインコンテンツ -->
        <div class="flex-1 overflow-auto">
            <header class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-key mr-3 text-indigo-600"></i>API管理
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">APIキーの発行・管理と使用量の監視を行います</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-email" class="text-sm text-gray-600">admin@example.com</span>
                        <div id="last-updated" class="text-xs text-gray-500"></div>
                    </div>
                </div>
            </header>

            <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <!-- API統計カード -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- 総APIキー数 -->
                    <div class="bg-white overflow-hidden shadow rounded-lg api-card">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                    <i class="fas fa-key text-white text-2xl"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">総APIキー数</dt>
                                        <dd class="text-2xl font-semibold text-gray-900" id="total-api-keys">5</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- アクティブキー数 -->
                    <div class="bg-white overflow-hidden shadow rounded-lg api-card">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                                    <i class="fas fa-check-circle text-white text-2xl"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">アクティブキー</dt>
                                        <dd class="text-2xl font-semibold text-gray-900" id="active-api-keys">3</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 今日のAPI呼び出し数 -->
                    <div class="bg-white overflow-hidden shadow rounded-lg api-card">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                                    <i class="fas fa-chart-line text-white text-2xl"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">今日の呼び出し</dt>
                                        <dd class="text-2xl font-semibold text-gray-900" id="today-api-calls">1,247</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- レート制限警告 -->
                    <div class="bg-white overflow-hidden shadow rounded-lg api-card">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">制限近接</dt>
                                        <dd class="text-2xl font-semibold text-gray-900" id="rate-limit-warnings">1</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APIキー管理パネル -->
                <div class="bg-white shadow rounded-lg p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-cogs mr-2 text-indigo-600"></i>APIキー管理
                        </h3>
                        <div class="flex space-x-3">
                            <button id="create-api-key" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors duration-200">
                                <i class="fas fa-plus mr-2"></i>新規APIキー作成
                            </button>
                            <button id="refresh-api-keys" class="px-4 py-2 bg-gray-600 text-white rounded-md text-sm font-medium hover:bg-gray-700 transition-colors duration-200">
                                <i class="fas fa-sync mr-2"></i>更新
                            </button>
                        </div>
                    </div>

                    <!-- 検索・フィルター -->
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <input type="text" id="api-key-search" placeholder="APIキー名、説明で検索..." 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex space-x-2">
                            <select id="api-key-status-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">全ステータス</option>
                                <option value="active">アクティブ</option>
                                <option value="inactive">非アクティブ</option>
                                <option value="suspended">停止中</option>
                            </select>
                            <select id="api-key-type-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">全タイプ</option>
                                <option value="read">読み取り専用</option>
                                <option value="write">書き込み可能</option>
                                <option value="admin">管理者</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- APIキー一覧 -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-list mr-2 text-indigo-600"></i>APIキー一覧
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">発行されたAPIキーの一覧と使用状況</p>
                    </div>

                    <!-- デスクトップ用テーブル -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        APIキー名
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        キー
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        タイプ
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        使用量
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ステータス
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        最終使用
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        操作
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="api-keys-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- APIキー一覧がここに表示される -->
                            </tbody>
                        </table>
                    </div>

                    <!-- モバイル用カード表示 -->
                    <div class="md:hidden" id="mobile-api-keys-list">
                        <!-- モバイル用APIキーカードがここに表示される -->
                    </div>
                </div>

                <!-- 使用量統計グラフ -->
                <div class="mt-8 bg-white shadow rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>API使用量統計
                        </h3>
                        <div class="flex space-x-2">
                            <select id="usage-period" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="7">直近7日間</option>
                                <option value="30" selected>直近30日間</option>
                                <option value="90">直近90日間</option>
                            </select>
                            <select id="usage-api-key" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">全APIキー</option>
                            </select>
                        </div>
                    </div>
                    <div class="usage-chart">
                        <canvas id="usage-chart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- APIキー作成モーダル -->
    <div id="create-api-key-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 modal-backdrop">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-plus-circle mr-2 text-indigo-600"></i>新規APIキー作成
                </h3>
                <button id="close-create-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="create-api-key-form" class="mt-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">APIキー名 *</label>
                    <input type="text" id="new-api-key-name" required 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="例: メインアプリケーション用API">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">説明</label>
                    <textarea id="new-api-key-description" rows="3" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="このAPIキーの用途や説明を入力してください"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">権限レベル *</label>
                    <select id="new-api-key-type" required 
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">選択してください</option>
                        <option value="read">読み取り専用 - データの参照のみ</option>
                        <option value="write">書き込み可能 - データの作成・更新・削除</option>
                        <option value="admin">管理者 - 全ての操作が可能</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">レート制限（1時間あたり）</label>
                    <select id="new-api-key-rate-limit" 
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="100">100リクエスト/時間（基本）</option>
                        <option value="500">500リクエスト/時間（標準）</option>
                        <option value="1000" selected>1,000リクエスト/時間（高）</option>
                        <option value="5000">5,000リクエスト/時間（プレミアム）</option>
                        <option value="unlimited">無制限</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">アクセス制限</label>
                    <div class="space-y-3">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="ip-restriction-enabled" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-700">IPアドレス制限を有効にする</span>
                            </label>
                        </div>
                        <div id="ip-restriction-config" class="hidden ml-6">
                            <textarea id="allowed-ips" rows="3" 
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                      placeholder="192.168.1.0/24&#10;203.0.113.0/24&#10;（1行に1つのIPアドレスまたはCIDR）"></textarea>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">有効期限</label>
                    <select id="new-api-key-expiry" 
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">無期限</option>
                        <option value="30">30日後</option>
                        <option value="90">90日後</option>
                        <option value="365">1年後</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                
                <div id="custom-expiry" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">カスタム有効期限</label>
                    <input type="date" id="custom-expiry-date" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </form>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-create-api-key" type="button" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    キャンセル
                </button>
                <button id="confirm-create-api-key" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">
                    <i class="fas fa-key mr-2"></i>APIキー作成
                </button>
            </div>
        </div>
    </div>

    <!-- APIキー表示モーダル -->
    <div id="api-key-display-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 modal-backdrop">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white modal-content">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">APIキーが作成されました</h3>
                <p class="text-sm text-gray-500 mb-4">
                    以下のAPIキーを安全な場所に保存してください。<br>
                    <strong>このキーは二度と表示されません。</strong>
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">APIキー</label>
                    <div class="api-key-display" id="generated-api-key">
                        <!-- 生成されたAPIキーがここに表示される -->
                    </div>
                    <button id="copy-api-key" class="mt-2 copy-button px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">
                        <i class="fas fa-copy mr-1"></i>コピー
                    </button>
                </div>
                <div class="flex justify-center">
                    <button id="close-display-modal" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">
                        確認しました
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- APIキー詳細・編集モーダル -->
    <div id="api-key-detail-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 modal-backdrop">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-info-circle mr-2 text-indigo-600"></i>APIキー詳細
                </h3>
                <button id="close-detail-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mt-6" id="api-key-detail-content">
                <!-- APIキー詳細情報がここに表示される -->
            </div>
            
            <div class="mt-6 flex justify-between">
                <div class="space-x-3">
                    <button id="regenerate-api-key" class="px-4 py-2 bg-yellow-600 text-white rounded-md text-sm font-medium hover:bg-yellow-700">
                        <i class="fas fa-sync mr-2"></i>キー再生成
                    </button>
                    <button id="toggle-api-key-status" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-power-off mr-2"></i>ステータス切替
                    </button>
                </div>
                <div class="space-x-3">
                    <button id="save-api-key-changes" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700">
                        <i class="fas fa-save mr-2"></i>変更保存
                    </button>
                    <button id="delete-api-key" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                        <i class="fas fa-trash mr-2"></i>削除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class APIKeyManager {
            constructor() {
                this.supabaseClient = null;
                this.currentUser = null;
                this.apiKeys = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.totalItems = 0;
                this.currentFilters = {
                    search: '',
                    status: '',
                    type: ''
                };
                this.selectedApiKeyId = null;
                this.usageChart = null;
                
                // サンプルデータ
                this.sampleApiKeys = [
                    {
                        id: '1',
                        name: 'メインアプリケーション',
                        key: 'sk_live_1234567890abcdef1234567890abcdef',
                        description: 'メインWebアプリケーション用のAPIキー',
                        type: 'write',
                        status: 'active',
                        rate_limit: 1000,
                        usage_today: 245,
                        usage_month: 8756,
                        last_used: '2024-12-01T14:30:00Z',
                        created_at: '2024-11-01T10:00:00Z',
                        ip_restrictions: ['192.168.1.0/24'],
                        expires_at: null
                    },
                    {
                        id: '2',
                        name: 'データ分析ツール',
                        key: 'sk_live_abcdef1234567890abcdef1234567890',
                        description: '分析レポート生成用の読み取り専用キー',
                        type: 'read',
                        status: 'active',
                        rate_limit: 500,
                        usage_today: 89,
                        usage_month: 2341,
                        last_used: '2024-12-01T12:15:00Z',
                        created_at: '2024-10-15T09:30:00Z',
                        ip_restrictions: [],
                        expires_at: '2025-01-15T00:00:00Z'
                    },
                    {
                        id: '3',
                        name: 'テスト環境',
                        key: 'sk_test_9876543210fedcba9876543210fedcba',
                        description: '開発・テスト用APIキー',
                        type: 'admin',
                        status: 'inactive',
                        rate_limit: 100,
                        usage_today: 0,
                        usage_month: 156,
                        last_used: '2024-11-28T16:45:00Z',
                        created_at: '2024-11-20T11:00:00Z',
                        ip_restrictions: ['203.0.113.0/24'],
                        expires_at: null
                    },
                    {
                        id: '4',
                        name: 'モバイルアプリ',
                        key: 'sk_live_fedcba0987654321fedcba0987654321',
                        description: 'モバイルアプリケーション用APIキー',
                        type: 'write',
                        status: 'active',
                        rate_limit: 2000,
                        usage_today: 892,
                        usage_month: 15643,
                        last_used: '2024-12-01T15:22:00Z',
                        created_at: '2024-09-01T08:00:00Z',
                        ip_restrictions: [],
                        expires_at: null
                    },
                    {
                        id: '5',
                        name: 'バックアップスクリプト',
                        key: 'sk_live_5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a',
                        description: '自動バックアップ処理用のAPIキー',
                        type: 'read',
                        status: 'suspended',
                        rate_limit: 50,
                        usage_today: 21,
                        usage_month: 4521,
                        last_used: '2024-11-30T23:59:00Z',
                        created_at: '2024-08-15T14:20:00Z',
                        ip_restrictions: ['10.0.0.0/8'],
                        expires_at: '2024-12-15T00:00:00Z'
                    }
                ];
            }

            async initialize() {
                try {
                    console.log('API管理システム初期化開始...');
                    
                    // イベントリスナー設定
                    this.setupEventListeners();
                    
                    // データ読み込み
                    await this.loadApiKeysData();
                    
                    // 使用量チャート初期化
                    this.initializeUsageChart();
                    
                    // 最終更新時刻を表示
                    this.updateLastUpdated();
                    
                    console.log('✅ API管理システム初期化完了');
                    
                } catch (error) {
                    console.error('❌ 初期化エラー:', error);
                    this.showError('システムの初期化に失敗しました。');
                }
            }

            setupEventListeners() {
                // APIキー作成
                document.getElementById('create-api-key').addEventListener('click', () => this.showCreateModal());
                document.getElementById('confirm-create-api-key').addEventListener('click', () => this.createApiKey());
                document.getElementById('cancel-create-api-key').addEventListener('click', () => this.closeCreateModal());
                document.getElementById('close-create-modal').addEventListener('click', () => this.closeCreateModal());

                // APIキー表示モーダル
                document.getElementById('copy-api-key').addEventListener('click', () => this.copyApiKey());
                document.getElementById('close-display-modal').addEventListener('click', () => this.closeDisplayModal());

                // APIキー詳細モーダル
                document.getElementById('close-detail-modal').addEventListener('click', () => this.closeDetailModal());
                document.getElementById('save-api-key-changes').addEventListener('click', () => this.saveApiKeyChanges());
                document.getElementById('delete-api-key').addEventListener('click', () => this.deleteApiKey());
                document.getElementById('regenerate-api-key').addEventListener('click', () => this.regenerateApiKey());
                document.getElementById('toggle-api-key-status').addEventListener('click', () => this.toggleApiKeyStatus());

                // 検索・フィルター
                const searchInput = document.getElementById('api-key-search');
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.currentFilters.search = e.target.value;
                        this.currentPage = 1;
                        this.renderApiKeys();
                    }, 500);
                });

                document.getElementById('api-key-status-filter').addEventListener('change', (e) => {
                    this.currentFilters.status = e.target.value;
                    this.currentPage = 1;
                    this.renderApiKeys();
                });

                document.getElementById('api-key-type-filter').addEventListener('change', (e) => {
                    this.currentFilters.type = e.target.value;
                    this.currentPage = 1;
                    this.renderApiKeys();
                });

                // 動的フォーム制御
                document.getElementById('ip-restriction-enabled').addEventListener('change', (e) => {
                    const configDiv = document.getElementById('ip-restriction-config');
                    if (e.target.checked) {
                        configDiv.classList.remove('hidden');
                    } else {
                        configDiv.classList.add('hidden');
                    }
                });

                document.getElementById('new-api-key-expiry').addEventListener('change', (e) => {
                    const customDiv = document.getElementById('custom-expiry');
                    if (e.target.value === 'custom') {
                        customDiv.classList.remove('hidden');
                    } else {
                        customDiv.classList.add('hidden');
                    }
                });

                // 使用量チャート期間変更
                document.getElementById('usage-period').addEventListener('change', (e) => {
                    this.updateUsageChart(parseInt(e.target.value));
                });

                document.getElementById('usage-api-key').addEventListener('change', (e) => {
                    this.updateUsageChart(null, e.target.value);
                });

                // 更新ボタン
                document.getElementById('refresh-api-keys').addEventListener('click', () => this.loadApiKeysData());
            }

            async loadApiKeysData() {
                try {
                    // サンプルデータを使用
                    this.apiKeys = this.sampleApiKeys;
                    this.totalItems = this.apiKeys.length;
                    
                    this.renderApiKeys();
                    this.updateApiKeyStats();
                    this.updateUsageApiKeyOptions();
                    
                } catch (error) {
                    console.error('APIキー情報の読み込みエラー:', error);
                    this.showError('APIキー情報の読み込みに失敗しました。');
                }
            }

            renderApiKeys() {
                const tbody = document.getElementById('api-keys-table-body');
                const mobileContainer = document.getElementById('mobile-api-keys-list');
                
                // フィルター適用
                let filteredKeys = this.apiKeys;
                if (this.currentFilters.search) {
                    filteredKeys = filteredKeys.filter(key => 
                        key.name.toLowerCase().includes(this.currentFilters.search.toLowerCase()) ||
                        (key.description && key.description.toLowerCase().includes(this.currentFilters.search.toLowerCase()))
                    );
                }
                if (this.currentFilters.status) {
                    filteredKeys = filteredKeys.filter(key => key.status === this.currentFilters.status);
                }
                if (this.currentFilters.type) {
                    filteredKeys = filteredKeys.filter(key => key.type === this.currentFilters.type);
                }

                if (filteredKeys.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                                該当するAPIキーはありません。
                            </td>
                        </tr>
                    `;
                    mobileContainer.innerHTML = `
                        <div class="p-4 text-center text-sm text-gray-500">
                            該当するAPIキーはありません。
                        </div>
                    `;
                    return;
                }

                // デスクトップ用テーブル
                tbody.innerHTML = filteredKeys.map(apiKey => `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="app.viewApiKeyDetail('${apiKey.id}')">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${this.escapeHtml(apiKey.name)}</div>
                            <div class="text-sm text-gray-500">${this.escapeHtml(apiKey.description || '')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">${this.maskApiKey(apiKey.key)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${this.getTypeBadge(apiKey.type)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${apiKey.usage_today}/${apiKey.rate_limit}</div>
                            <div class="rate-limit-bar bg-gray-200">
                                <div class="rate-limit-progress bg-${this.getUsageColor(apiKey.usage_today, apiKey.rate_limit)}-500" 
                                     style="width: ${Math.min((apiKey.usage_today / apiKey.rate_limit) * 100, 100)}%"></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${this.getStatusBadge(apiKey.status)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${apiKey.last_used ? new Date(apiKey.last_used).toLocaleDateString('ja-JP') : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="event.stopPropagation(); app.viewApiKeyDetail('${apiKey.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); app.toggleApiKeyStatus('${apiKey.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="event.stopPropagation(); app.deleteApiKey('${apiKey.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // モバイル用カード表示
                mobileContainer.innerHTML = filteredKeys.map(apiKey => `
                    <div class="border-b border-gray-200 p-4 hover:bg-gray-50 cursor-pointer" onclick="app.viewApiKeyDetail('${apiKey.id}')">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-900">${this.escapeHtml(apiKey.name)}</h4>
                            ${this.getStatusBadge(apiKey.status)}
                        </div>
                        <div class="text-xs text-gray-500 mb-2">${this.escapeHtml(apiKey.description || '')}</div>
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                            <span>使用量: ${apiKey.usage_today}/${apiKey.rate_limit}</span>
                            ${this.getTypeBadge(apiKey.type)}
                        </div>
                        <div class="rate-limit-bar bg-gray-200 mb-2">
                            <div class="rate-limit-progress bg-${this.getUsageColor(apiKey.usage_today, apiKey.rate_limit)}-500" 
                                 style="width: ${Math.min((apiKey.usage_today / apiKey.rate_limit) * 100, 100)}%"></div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">
                                最終使用: ${apiKey.last_used ? new Date(apiKey.last_used).toLocaleDateString('ja-JP') : '-'}
                            </span>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); app.toggleApiKeyStatus('${apiKey.id}')" class="text-blue-600 text-xs">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.deleteApiKey('${apiKey.id}')" class="text-red-600 text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                this.totalItems = filteredKeys.length;
            }

            updateApiKeyStats() {
                document.getElementById('total-api-keys').textContent = this.apiKeys.length;
                
                const activeKeys = this.apiKeys.filter(key => key.status === 'active').length;
                document.getElementById('active-api-keys').textContent = activeKeys;
                
                const totalTodayCalls = this.apiKeys.reduce((sum, key) => sum + key.usage_today, 0);
                document.getElementById('today-api-calls').textContent = totalTodayCalls.toLocaleString();
                
                const rateLimitWarnings = this.apiKeys.filter(key => 
                    key.usage_today / key.rate_limit > 0.8 && key.status === 'active'
                ).length;
                document.getElementById('rate-limit-warnings').textContent = rateLimitWarnings;
            }

            showCreateModal() {
                document.getElementById('create-api-key-modal').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            closeCreateModal() {
                document.getElementById('create-api-key-modal').classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                document.getElementById('create-api-key-form').reset();
                document.getElementById('ip-restriction-config').classList.add('hidden');
                document.getElementById('custom-expiry').classList.add('hidden');
            }

            async createApiKey() {
                try {
                    const formData = {
                        name: document.getElementById('new-api-key-name').value,
                        description: document.getElementById('new-api-key-description').value,
                        type: document.getElementById('new-api-key-type').value,
                        rateLimit: document.getElementById('new-api-key-rate-limit').value,
                        ipRestriction: document.getElementById('ip-restriction-enabled').checked,
                        allowedIps: document.getElementById('allowed-ips').value.split('\n').filter(ip => ip.trim()),
                        expiry: document.getElementById('new-api-key-expiry').value,
                        customExpiryDate: document.getElementById('custom-expiry-date').value
                    };

                    // バリデーション
                    if (!formData.name || !formData.type) {
                        this.showError('必須項目を入力してください。');
                        return;
                    }

                    // APIキー生成
                    const generatedKey = this.generateApiKey();
                    
                    // 新しいAPIキーオブジェクト作成
                    const newApiKey = {
                        id: Date.now().toString(),
                        name: formData.name,
                        key: generatedKey,
                        description: formData.description,
                        type: formData.type,
                        status: 'active',
                        rate_limit: parseInt(formData.rateLimit === 'unlimited' ? 999999 : formData.rateLimit),
                        usage_today: 0,
                        usage_month: 0,
                        last_used: null,
                        created_at: new Date().toISOString(),
                        ip_restrictions: formData.ipRestriction ? formData.allowedIps : [],
                        expires_at: this.calculateExpiryDate(formData.expiry, formData.customExpiryDate)
                    };

                    // サンプルデータに追加
                    this.apiKeys.push(newApiKey);
                    
                    this.closeCreateModal();
                    this.showGeneratedApiKey(generatedKey);
                    this.loadApiKeysData();
                    
                } catch (error) {
                    console.error('APIキー作成エラー:', error);
                    this.showError('APIキーの作成に失敗しました。');
                }
            }

            generateApiKey() {
                const prefix = 'sk_live_';
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = prefix;
                for (let i = 0; i < 32; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            calculateExpiryDate(expiry, customDate) {
                if (!expiry) return null;
                if (expiry === 'custom') return customDate ? new Date(customDate).toISOString() : null;
                
                const now = new Date();
                const days = parseInt(expiry);
                now.setDate(now.getDate() + days);
                return now.toISOString();
            }

            showGeneratedApiKey(apiKey) {
                document.getElementById('generated-api-key').textContent = apiKey;
                document.getElementById('api-key-display-modal').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            closeDisplayModal() {
                document.getElementById('api-key-display-modal').classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            async copyApiKey() {
                try {
                    const apiKey = document.getElementById('generated-api-key').textContent;
                    await navigator.clipboard.writeText(apiKey);
                    
                    const button = document.getElementById('copy-api-key');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>コピー済み';
                    button.classList.add('bg-green-500', 'text-white');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-green-500', 'text-white');
                    }, 2000);
                    
                } catch (error) {
                    console.error('コピーエラー:', error);
                    this.showError('クリップボードへのコピーに失敗しました。');
                }
            }

            viewApiKeyDetail(apiKeyId) {
                this.selectedApiKeyId = apiKeyId;
                const apiKey = this.apiKeys.find(key => key.id === apiKeyId);
                
                if (!apiKey) return;
                
                const detailContent = document.getElementById('api-key-detail-content');
                detailContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- 基本情報 -->
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-4">基本情報</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">APIキー名</label>
                                        <input type="text" id="edit-api-key-name" value="${this.escapeHtml(apiKey.name)}" 
                                               class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">説明</label>
                                        <textarea id="edit-api-key-description" rows="3" 
                                                  class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">${this.escapeHtml(apiKey.description || '')}</textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">権限レベル</label>
                                        <select id="edit-api-key-type" 
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="read" ${apiKey.type === 'read' ? 'selected' : ''}>読み取り専用</option>
                                            <option value="write" ${apiKey.type === 'write' ? 'selected' : ''}>書き込み可能</option>
                                            <option value="admin" ${apiKey.type === 'admin' ? 'selected' : ''}>管理者</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">レート制限（1時間あたり）</label>
                                        <select id="edit-api-key-rate-limit" 
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="100" ${apiKey.rate_limit === 100 ? 'selected' : ''}>100リクエスト/時間</option>
                                            <option value="500" ${apiKey.rate_limit === 500 ? 'selected' : ''}>500リクエスト/時間</option>
                                            <option value="1000" ${apiKey.rate_limit === 1000 ? 'selected' : ''}>1,000リクエスト/時間</option>
                                            <option value="5000" ${apiKey.rate_limit === 5000 ? 'selected' : ''}>5,000リクエスト/時間</option>
                                            <option value="unlimited" ${apiKey.rate_limit >= 999999 ? 'selected' : ''}>無制限</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- セキュリティ設定 -->
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-4">セキュリティ設定</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="edit-ip-restriction-enabled" ${apiKey.ip_restrictions.length > 0 ? 'checked' : ''} 
                                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-sm text-gray-700">IPアドレス制限を有効にする</span>
                                        </label>
                                    </div>
                                    <div id="edit-ip-restriction-config" class="${apiKey.ip_restrictions.length > 0 ? '' : 'hidden'} ml-6">
                                        <textarea id="edit-allowed-ips" rows="3" 
                                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                                  placeholder="192.168.1.0/24&#10;203.0.113.0/24">${apiKey.ip_restrictions.join('\n')}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 統計情報 -->
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-4">使用統計</h4>
                                <div class="api-stats-grid">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="text-2xl font-semibold text-gray-900">${apiKey.usage_today}</div>
                                        <div class="text-sm text-gray-600">今日の使用量</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="text-2xl font-semibold text-gray-900">${apiKey.usage_month.toLocaleString()}</div>
                                        <div class="text-sm text-gray-600">今月の使用量</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="text-2xl font-semibold text-gray-900">${apiKey.rate_limit >= 999999 ? '無制限' : apiKey.rate_limit.toLocaleString()}</div>
                                        <div class="text-sm text-gray-600">制限値/時間</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="text-2xl font-semibold text-gray-900">${Math.round((apiKey.usage_today / apiKey.rate_limit) * 100)}%</div>
                                        <div class="text-sm text-gray-600">使用率</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-4">APIキー情報</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">APIキー</label>
                                        <div class="mt-1 flex">
                                            <div class="api-key-display flex-1">${this.maskApiKey(apiKey.key)}</div>
                                            <button onclick="app.copyToClipboard('${apiKey.key}')" class="ml-2 copy-button px-3 py-1 border border-gray-300 rounded text-sm">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">ステータス</label>
                                            <div class="mt-1">${this.getStatusBadge(apiKey.status)}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">権限</label>
                                            <div class="mt-1">${this.getTypeBadge(apiKey.type)}</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">作成日時</label>
                                            <div class="mt-1 text-sm text-gray-900">${new Date(apiKey.created_at).toLocaleString('ja-JP')}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">最終使用</label>
                                            <div class="mt-1 text-sm text-gray-900">${apiKey.last_used ? new Date(apiKey.last_used).toLocaleString('ja-JP') : '-'}</div>
                                        </div>
                                    </div>
                                    ${apiKey.expires_at ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">有効期限</label>
                                        <div class="mt-1 text-sm text-gray-900">${new Date(apiKey.expires_at).toLocaleString('ja-JP')}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // IP制限の動的制御
                document.getElementById('edit-ip-restriction-enabled').addEventListener('change', (e) => {
                    const configDiv = document.getElementById('edit-ip-restriction-config');
                    if (e.target.checked) {
                        configDiv.classList.remove('hidden');
                    } else {
                        configDiv.classList.add('hidden');
                    }
                });
                
                document.getElementById('api-key-detail-modal').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            closeDetailModal() {
                document.getElementById('api-key-detail-modal').classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                this.selectedApiKeyId = null;
            }

            async saveApiKeyChanges() {
                try {
                    const apiKey = this.apiKeys.find(key => key.id === this.selectedApiKeyId);
                    if (!apiKey) return;

                    // フォームデータを取得
                    apiKey.name = document.getElementById('edit-api-key-name').value;
                    apiKey.description = document.getElementById('edit-api-key-description').value;
                    apiKey.type = document.getElementById('edit-api-key-type').value;
                    apiKey.rate_limit = parseInt(document.getElementById('edit-api-key-rate-limit').value === 'unlimited' ? 999999 : document.getElementById('edit-api-key-rate-limit').value);
                    
                    const ipRestrictionEnabled = document.getElementById('edit-ip-restriction-enabled').checked;
                    apiKey.ip_restrictions = ipRestrictionEnabled ? 
                        document.getElementById('edit-allowed-ips').value.split('\n').filter(ip => ip.trim()) : [];
                    
                    this.showSuccess('APIキーの設定を更新しました。');
                    this.closeDetailModal();
                    this.loadApiKeysData();
                    
                } catch (error) {
                    console.error('APIキー更新エラー:', error);
                    this.showError('APIキーの更新に失敗しました。');
                }
            }

            async deleteApiKey(apiKeyId = null) {
                const id = apiKeyId || this.selectedApiKeyId;
                const apiKey = this.apiKeys.find(key => key.id === id);
                
                if (!apiKey) return;
                
                if (!confirm(`APIキー "${apiKey.name}" を削除しますか？\n\nこの操作は元に戻すことができません。`)) return;
                
                try {
                    this.apiKeys = this.apiKeys.filter(key => key.id !== id);
                    
                    this.showSuccess('APIキーを削除しました。');
                    this.loadApiKeysData();
                    
                    if (this.selectedApiKeyId === id) {
                        this.closeDetailModal();
                    }
                    
                } catch (error) {
                    console.error('削除エラー:', error);
                    this.showError('APIキーの削除に失敗しました。');
                }
            }

            async regenerateApiKey() {
                const apiKey = this.apiKeys.find(key => key.id === this.selectedApiKeyId);
                if (!apiKey) return;
                
                if (!confirm(`APIキー "${apiKey.name}" を再生成しますか？\n\n現在のキーは無効になり、新しいキーが生成されます。`)) return;
                
                try {
                    const newKey = this.generateApiKey();
                    apiKey.key = newKey;
                    
                    this.showSuccess('APIキーを再生成しました。');
                    this.showGeneratedApiKey(newKey);
                    this.closeDetailModal();
                    this.loadApiKeysData();
                    
                } catch (error) {
                    console.error('再生成エラー:', error);
                    this.showError('APIキーの再生成に失敗しました。');
                }
            }

            async toggleApiKeyStatus(apiKeyId = null) {
                const id = apiKeyId || this.selectedApiKeyId;
                const apiKey = this.apiKeys.find(key => key.id === id);
                
                if (!apiKey) return;
                
                try {
                    const newStatus = apiKey.status === 'active' ? 'inactive' : 'active';
                    const action = newStatus === 'active' ? '有効化' : '無効化';
                    
                    if (!confirm(`APIキー "${apiKey.name}" を${action}しますか？`)) return;
                    
                    apiKey.status = newStatus;
                    
                    this.showSuccess(`APIキーを${action}しました。`);
                    this.loadApiKeysData();
                    
                    if (this.selectedApiKeyId === id) {
                        this.viewApiKeyDetail(id); // 詳細画面を更新
                    }
                    
                } catch (error) {
                    console.error('ステータス変更エラー:', error);
                    this.showError('APIキーのステータス変更に失敗しました。');
                }
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    this.showSuccess('クリップボードにコピーしました。');
                } catch (error) {
                    console.error('コピーエラー:', error);
                    this.showError('クリップボードへのコピーに失敗しました。');
                }
            }

            initializeUsageChart() {
                const ctx = document.getElementById('usage-chart').getContext('2d');
                
                this.usageChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'API呼び出し数',
                            data: [],
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderColor: 'rgba(79, 70, 229, 0.8)',
                            borderWidth: 2,
                            pointBackgroundColor: 'white',
                            pointBorderColor: 'rgba(79, 70, 229, 0.8)',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 14
                                },
                                callbacks: {
                                    label: function(context) {
                                        return `API呼び出し数: ${context.raw.toLocaleString()}回`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    callback: function(value) {
                                        return value % 1 === 0 ? value.toLocaleString() : null;
                                    }
                                }
                            }
                        }
                    }
                });
                
                this.updateUsageChart(30);
            }

            async updateUsageChart(days = 30, apiKeyId = '') {
                try {
                    // サンプルデータを生成
                    const labels = [];
                    const data = [];
                    
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' }));
                        
                        // ランダムな使用量データを生成
                        const baseUsage = Math.floor(Math.random() * 500) + 50;
                        const variation = Math.floor(Math.random() * 200) - 100;
                        data.push(Math.max(0, baseUsage + variation));
                    }
                    
                    this.usageChart.data.labels = labels;
                    this.usageChart.data.datasets[0].data = data;
                    this.usageChart.update();
                    
                } catch (error) {
                    console.error('使用量チャート更新エラー:', error);
                    this.showError('使用量データの更新に失敗しました。');
                }
            }

            updateUsageApiKeyOptions() {
                const select = document.getElementById('usage-api-key');
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">全APIキー</option>';
                this.apiKeys.forEach(apiKey => {
                    const option = document.createElement('option');
                    option.value = apiKey.id;
                    option.textContent = apiKey.name;
                    if (apiKey.id === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }

            // ユーティリティ関数
            getTypeBadge(type) {
                const typeMap = {
                    'read': { text: '読み取り', color: 'bg-blue-100 text-blue-800' },
                    'write': { text: '書き込み', color: 'bg-green-100 text-green-800' },
                    'admin': { text: '管理者', color: 'bg-purple-100 text-purple-800' }
                };
                
                const typeInfo = typeMap[type] || { text: type, color: 'bg-gray-100 text-gray-800' };
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeInfo.color}">
                    ${typeInfo.text}
                </span>`;
            }

            getStatusBadge(status) {
                const statusMap = {
                    'active': { text: 'アクティブ', color: 'bg-green-100 text-green-800' },
                    'inactive': { text: '非アクティブ', color: 'bg-gray-100 text-gray-800' },
                    'suspended': { text: '停止中', color: 'bg-red-100 text-red-800' }
                };
                
                const statusInfo = statusMap[status] || { text: status, color: 'bg-gray-100 text-gray-800' };
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.color} status-indicator status-${status}">
                    ${statusInfo.text}
                </span>`;
            }

            maskApiKey(key) {
                if (key.length <= 12) return key;
                return key.substring(0, 8) + '...' + key.substring(key.length - 4);
            }

            getUsageColor(usage, limit) {
                const ratio = usage / limit;
                if (ratio >= 0.9) return 'red';
                if (ratio >= 0.7) return 'yellow';
                return 'green';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateLastUpdated() {
                const lastUpdated = document.getElementById('last-updated');
                if (lastUpdated) {
                    lastUpdated.textContent = `最終更新: ${new Date().toLocaleTimeString('ja-JP')}`;
                }
            }

            showError(message) {
                const errorBanner = document.getElementById('error-banner');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = message;
                errorBanner.classList.remove('hidden');
                
                setTimeout(() => {
                    errorBanner.classList.add('hidden');
                }, 5000);
            }

            showSuccess(message) {
                const successBanner = document.getElementById('success-banner');
                const successMessage = document.getElementById('success-message');
                successMessage.textContent = message;
                successBanner.classList.remove('hidden');
                
                setTimeout(() => {
                    successBanner.classList.add('hidden');
                }, 3000);
            }
        }

        // アプリケーションインスタンスを作成
        const app = new APIKeyManager();

        // ページロード時の初期化
        window.addEventListener('load', () => {
            app.initialize();
        });

        // グローバル関数として公開
        window.hideErrorBanner = () => {
            document.getElementById('error-banner').classList.add('hidden');
        };
        
        window.hideSuccessBanner = () => {
            document.getElementById('success-banner').classList.add('hidden');
        };
    </script>
</body>
</html>